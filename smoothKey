## -*- coding: utf-8 -*-

import maya.cmds as cmds
def smoothKeys(NumberOfTimes):
    def smoothFunc(val,Strength):
        while Strength:
            average = (val[0]+val[1]+val[2])/3
            if Strength >= 1:
                val[1] = average
            Strength -= 1
        return average
    
    #アニメーションカーブの名前を変数に格納
    AnimCurves = cmds.keyframe(q=1,name=1)
    
    #アニメーションカーブが無い場合、エラーを返す
    if len(AnimCurves) == 0:
        cmds.error("アニメーションカーブがありません")
    
    #変数の初期化
    PrevValue = 0
    CurrValue = 0
    NextValue = 0
    FrameNum = []
    ArraySize = 0
    DupCurve = ""
    DupCurveVal = 0
    
    #取得したアニメーションカーブ全てをループ処理
    for AnimCurve in AnimCurves:
        #もしキーを１つも選択していない場合、全てのアニメーションカーブのキーを選択する
        if cmds.keyframe(cmds.ls(sl=1),q=1,sl=1) == None:
            cmds.selectKey(cmds.keyframe(q=1,n=1))
        #選択しているキーのフレームを取得
        FrameNum = cmds.keyframe(AnimCurve,q=1,sl=1)
        #選択しているキーフレームの数を取得
        ArraySize = len(FrameNum)
        #アニメーションカーブを複製
        DupCurve = cmds.duplicate(AnimCurve)[0]
        #スムース回数をカウントする変数の初期化
        count = 1
        #指定した回数分、スムース処理を実行
        while count <= NumberOfTimes:
            #インデント番号の初期化
            i = 1
            while i < ArraySize-1:
                #前キーの値を取得
                PrevValue = cmds.keyframe(DupCurve,q=1,vc=1,t=(FrameNum[i-1],FrameNum[i-1]))[0]
                #真ん中のキーの値を取得
                CurrValue = cmds.keyframe(DupCurve,q=1,vc=1,t=(FrameNum[i],FrameNum[i]))[0]
                #次のキーの値を取得。この時エラーが出たら(最後のキーになったら)処理を抜け出す。
                try:
                    NextValue = cmds.keyframe(DupCurve,q=1,vc=1,t=(FrameNum[i+1],FrameNum[i+1]))[0]
                except:
                    break
                #スムース関数の実行
                SmoothValue = smoothFunc([PrevValue,CurrValue,NextValue],1)
                #スムースした値に置き換える
                cmds.keyframe(DupCurve,t=(FrameNum[i],FrameNum[i]),absolute=1,vc=SmoothValue)
                #インデント番号をカウントアップ
                i += 1
            #カウント番号のカウントアップ
            count += 1
        #インデント番号の初期化
        i = 0
        #複製してスムースしたあとのカーブの各キーの値を、既存のキーの値を置き換える
        while i < ArraySize:
            #複製したカーブから、キーの値を取得
            DupCurveVal = cmds.keyframe(DupCurve,q=1,vc=1,t=(FrameNum[i],FrameNum[i]))[0]
            #値を置き換え
            cmds.keyframe(AnimCurve,t=(FrameNum[i],FrameNum[i]),absolute=1,vc=DupCurveVal)
            #フレームのインデントのカウントアップ
            i += 1
        #複製したカーブの削除
        cmds.delete(DupCurve)
#smoothKeys(1)

#UI作成
width = 175
if cmds.window("smKeysWindow",ex=1) == True:
    cmds.deleteUI("smKeysWindow")
cmds.window("smKeysWindow",w=width,sizeable=0)
cmds.columnLayout()
cmds.text("smooth Value\n※処理重いのでご注意")
cmds.intField("smKeysValue",v=1,w=width)
cmds.button(c="smoothKeys(cmds.intField(\"smKeysValue\",q=1,v=1))",l="run",w=width)
cmds.showWindow("smKeysWindow")
